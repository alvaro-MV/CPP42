#include "PmergeMe.hpp"

/* 
	Que necesito --> Una estructura de datos que soporte:

	- Extraer un subconjunto a través de par, impar.
	- Extraer un subconujnto a través de start-end. Como un substr pero general.
	- Inserción de forma sencilla (en realidad, todos).
	- Binary search and insertion, fundamentalmente con un pos.
	- Que pueda guardar un link al b que le corresponde. Esto es problematico, porque
		a la hora de hacer la recursividad ese campo no se puede reutilizar.
		La posible solucion es crear una copia sin iterador asociado.
		Tiene sentido crear una copia sin iterador asociado.
	
	- Otra posibilidad es trabajar con los indices. Guardar un indice que le corresponde.
		Este indice puede ser otra lista, que funcione como un stack, en el sentido de que
		conforme se hace una llamada recursiva, el indice se acumula en el frente de la lista.
		--> Push_front. Aunque tambien se puede hacer en el back y utilizar el back y pop_back, como en deque.
	
	- Si se hace con indices, se consigue que no se pisen lo fregado.
	- Sencillo acceder al array de b's. La cuestion es si después de las inserciones se ha de eliminar.
		Yo digo que no, porque si no habria que actualizar todos a cada momento.

	- Es una mierda, hay que trabajar con una puta copia, porque si no te vuelves loco.
	- Por lo tanto, basicamente, se trabaja construyendo el array, con dos iterador a y b, respectivamente.
	- 
*/
listBin	mergeInsertion(listBin lb) {
	std::map<uint32_t, uint32_t> binding;
	listBin llb;

	if (lb.size() == 1)
		return (lb);

    listBin b = splitMainChain(lb, binding);

	llb = mergeInsertion(lb);
    listBinIter it = llb.begin();
    listBinIter bit = b.begin();
    for (int i = 0; i < llb.size(); i++) {
        *bit = binding[*it];
		it++;
		bit++;
    }

	unsigned int prevMainChain = 0;
	unsigned int k = 1;
	while (!b.empty()) {
		unsigned int tNew = tSub(k);
		unsigned int tOld = tSub(k - 1);
		unsigned int nextMainChain = tNew + tOld;
		
		insertList(llb, b, nextMainChain, prevMainChain);
		prevMainChain = nextMainChain + 1;
		k++;
	}
	return (llb);
}

static void checkSorted(const listBin& lb) {
    if (lb.empty()) {
        std::cout << "OK" << std::endl;
        return;
    }
    listBin::const_iterator it = lb.begin();
    listBin::const_iterator next = it;
    ++next;
    while (next != lb.end()) {
        if (*next < *it) {
            std::cout << "KO" << std::endl;
			std::cout << "[" << *next << "]-|-" << "[" << *it << "]" << std::endl;
            return;
        }
        ++it;
        ++next;
    }
    std::cout << "OK" << std::endl;
}

int main() {
    listBin lb = {3018,4364,1130,9408,9430,5742,3415,3342,2476,3956,9923,4089,6889,7685,3243,1997,5169,503,8232,2017,1900,7644,650,932,7542,882,6435,2358,5171,8689,4973,2764,2290,5399,510,579,2538,2182,5292,7225,4536,2272,7426,1861,5515,7418,1968,6961,6818,9310,4129,9580,2210,5342,6984,300,3882,9492,2694,7495,939,7309,8903,6756,3693,4658,2468,7735,4727,8246,2077,7511,3103,637,1147,5613,9659,9843,5624,3302,1870,7968,2090,1131,4699,5824,7347,4133,3702,4621,3948,7552,2176,4384,3801,4031,5509,1253,1492,2122,2047,3155,5236,7575,5231,625,8539,51,1086,5567,5168,259,2898,5105,7337,5497,8005,1478,6054,5213,9475,5115,8312,3552,1667,7879,8519,6708,9074,9140,2466,2816,283,3735,2302,3757,3030,9565,5879,7572,6428,2718,8653,3502,4191,3970,8978,2748,9677,5801,4975,5,7420,9631,7074,7454,4371,6841,5917,1622,291,3909,945,9764,8174,8256,7848,8996,1533,5284,2507,8489,3713,2745,9991,9099,6044,547,7077,9588,5746,8622,3229,2951,9053,6870,766,9614,1260,1591,9188,126,1333,3393,8878,7406,9690,9663,2209,3201,6860,1852,2471,7745,3264,7243,745,1998,9250,5068,246,2701,9642,6857,1208,5660,9618,7592,9107,7112,2693,2851,9680,2196,3943,4917,2836,1986,3031,7469,8744,1640,1686,4568,8948,6021,2845,7564,1590,1137,5514,4935,9104,1823,2884,5277,9960,5290,1740,4402,8926,5822,3026,9293,2735,1573,8199,3076,2979,5526,5418,5229,2025,8431,3703,4515,3109,303,9507,7595,2994,9222,3081,3199,8850,8719,1662,3863,5492,1797,4663,4794,7722,2444,1717,6862,2511,4309,1676,7810,9532,4207,3922,372,9869,1383,1934,5798,3621,2076,4865,9755,2705,2233,8407,2577,1146,7753,6888,837,9800,4567,5143,9187,6682,6453,9181,6934,4652,7858,1838,9881,3518,4895,9931,1999,3739,9405,7697,9444,8318,6121,9768,1721,3771,5797,2289,2328,7272,8372,9093,5891,7795,7307,301,691,7715,1102,3320,2473,4790,8050,4773,1457,6323,1831,7049,8278,8422,8192,1341,3974,1818,9783,5134,3784,5479,217,8177,799,5205,5913,1217,9666,1168,8321,2287,6628,5288,3845,9321,5571,7732,6023,1559,6063,4900,8014,315,7888,471,3248,316,4072,6505,2867,4489,1609,7357,5188,8590,3313,3127,314,9814,9014,3900,1060,8938,2,7531,4891,1765,7460,8388,1153,1270,9894,9785,4187,4815,4471,838,6456,6246,8786,3040,8072,6877,8273,1455,9470,1261,3292,9945,9779,1887,8544,8309,8821,2217,5677,4120,5829,2768,3464,4286,9446,2454,5618,2419,95,7798,8959,9160,6457,6374,8093,1860,4617,6931,4570,8234,4624,6735,6772,3617,6879,1572,5638,4372,8979,3404,367,5042,7176,8413,9987,7375,4173,731,2344,1757,5305,5456,4904,4630,8296,4792,6639,9586,1152,3960,7016,99,4502,969,5010,8851,7686,7477,4228,8021,6205,6177,9253,5500,5645,4443,3218,7048,6911,3898,2353,6599,5012,1728,2205,9101,1398,8323,947,263,4566,9055,9029,3157,1231,3449,4399,1100,6454,264,7885,7378,9448,7999,2609,3524,7041,6878,7322,8230,2252,7774,794,5062,6956,7453,4278,7924,1417,8254,928,298,1255,2709,5332,2163,3106,5643,7212,3345,918,4066,6927,6582,4772,3055,8971,7878,7190,5196,1435,3912,5550,759,8077,6,6766,7668,4550,8149,482,7356,1878,9603,5755,6471,2135,5655,7467,1366,5599,6844,6603,5216,967,2320,6373,36,9086,1789,3672,1281,8462,2720,7734,2481,7681,1948,4948,4419,6123,1542,391,6086,6695,196,4966,2029,5849,6075,2434,6261,1335,8577,4367,5202,5420,5130,6055,2963,614,9313,4092,8331,9323,7250,6594,3994,1532,2991,3628,420,8593,1698,4545,9701,4809,2813,1228,5089,7348,8133,7305,4179,6685,3578,3929,2722,3256,6661,5436,8001,8588,1180,2637,3138,5984,1499,6005,3920,3893,9522,2011,5628,1847,1602,1828,3598,6657,91,2326,9933,9468,2904,3390,481,460,8057,1185,2835,6641,7744,7002,7631,5779,5011,3593,2218,3387,7381,3266,2004,8493,7827,1243,1483,1179,853,9652,8015,6360,2888,9549,9215,7082,4483,518,7100,9063,4783,5467,4466,5032,195,4678,3531,7478,1315,5704,6131,6965,2932,9348,1195,8511,4946,349,5090,3706,8718,2883,4432,2164,9369,6949,3681,6165,7805,7832,8247,7739,7405,3998,4785,1010,6703,441,8292,1795,8506,9608,3662,7170,5653,8219,5832,6799,600,5286,887,4875,5565,1007,4141,2576,2920,3360,2759,628,318,9638,5053,6909,8074,714,5523,3807,4306,2235,991,6593,4231,1389,7067,2244,6925,8271,4711,5207,1545,8760,4143,3624,7037,8459,5156,2331,4050,7270,1161,642,4857,2712,2018,1023,9056,5435,8591,2215,3815,8303,2452,778,7396,4787,9035,2865,6677,7786,8637,6196,1637,1574,9834,63,6867,8919,3478,4406,49,7713,5800,6004,1566,7755,1188,6590,9286,6847,9998,3954,3711,2793,6883,1386,1268,5219,2644,1738,1608,9269,7059,208,7493,9142,3221,5888,9058,2128,1680,6861,4584,2671,7033,7142,2799,5206,9242,1857,5605,1461,8196,3689,7479,1365,2941,6921,7509,239,9016,2736,1071,4655,6540,7215,4068,3034,8159,306,7497,9384,8426,6803,9433,2785,608,2723,3777,4576,1224,6441,8067,8275,9417,1922,7258,5534,5496,2497,8618,3480,4779,9934,3233,9571,6483,3166,7216,7501,5272,8891,6837,6396,4203,8925,9952,8280,205,5935,9364,3626,2021,1912,7313,3359,9639,3582,9263,3993,8017,8546,5350,7579,9714,3550,2432,7393,1043,8870,9244,6623,9355,5728,5757,4740,8141,8595,8325,814,4159,3110,6731,3489,5967,5710,6993,6884,8135,2137,5466,5427,9407,2954,6796,9520,2413,6229,1663,3300,6732,5894,7812,3297,8387,4793,5125,7162,769,1126,7684,8406,2965,2173,5354,1265,4313,6705,2996,7637,1682,1020,1275,281,224,6103,9765,3646,1606,5034,604,7385,863,9339,4438,5668,276,805,5691,9280,9661,5215,3760,6645,554,3891,6663,9249,9782,9921,9721,2911,3382,2293,9452,3287,6924,326,6556,9636,6295,9803,8557,9660,5094,2422,4165,5592,3728,4053,3838,8747,2242,6137,4633,447,7615,6776,5915,7228,5519,5000,1470,9435,9352,1908,3316,3819,2912,9256,3198,6015,1327,8108,1176,7570,9057,6852,8611,2890,7441,6646,7897,9702,2212,4025,3172,4469,933,415,5163,109,6607,3775,661,5293,613,5968,6833,871,8222,2056,4119,2067,7105,1977,6543,8249,3919,723,7316,631,1124,959,8755,8917,4712,9019,4465,8698,5470,7608,413,886,9606,9752,4063,1392,3510,1292,5144,1364,5956,8864,8721,2983,6344,5799,2450,6713,2138,277,4127,2554,3112,7925,6814,1933,6141,2341,931,1842,483,9976,7494,4782,1928,4704,4298,9076,6049,4531,8568,3150,1955,3618,7741,7581,9540,7040,5615,7241,1189,4415,5300,5692,8113,2240,4989,1465,6413,4706,9756,8255,9302,9620,7820,8554,652,4388,1471,5232,2875,9890,6491,7872,6656,9317,2171,8415,7195,3167,6128,1951,8068,3328,3200,8239,4833,8648,4176,9031,5878,2866,7066,2882,8800,3829,7538,2317,9942,5043,536,917,2255,1226,3361,7283,3541,5860,6010,2324,8265,9131,3798,2022,8955,7432,9088,3019,9089,5070,3257,3048,1592,3545,2879,9168,6945,7466,5246,7944,7803,6894,3508,6216,3947,4225,3928,1225,3870,8672,7403,9697,8612,8973,8508,2292,386,2757,740,9569,5696,3113,5457,7386,3808,6823,9299,663,5876,1875,8964,2583,9893,2731,8733,6106,981,6529,9110,7969,599,3333,2397,7780,658,7959,312,9030,8226,7514,9199,5563,6154,9329,1134,1538,9538,6998,9359,9879,1464,2158,2657,8007,5557,8250,1046,7551,8316,2359,4212,8434,6919,4668,3941,495,5581,5271,3839,9943,8714,9985,7532,8784,7294,4615,6275,307,3588,3538,7638,3407,9138,9472,4013,388,5160,3444,9275,7656,4562,8885,6704,2307,7725,4015,7108,4941,6686,3575,2118,2416,1181,4088,2406,8105,3132,6112,9220,6612,3514,4662,4237,5380,9509,6524,7717,2357,1426,4688,1575,4889,4036,1251,693,1926,7221,8066,7658,7141,359,5387,7324,780,5275,9974,923,3668,6688,3017,5662,7728,6562,4349,796,9259,6501,5722,7379,983,6039,9085,4037,7602,3456,9501,4064,4538,7889,7428,7712,7705,1603,8268,1723,4520,1886,1328,8662,5583,5349,7449,6206,3967,2263,6741,8738,2323,90,7796,4732,3284,9489,3546,2916,8055,5814,107,3622,3,8283,8277,8688,4381,5170,958,8334,929,6764,2586,9700,2938,3716,6345,7085,1743,6825,3666,9328,4420,3195,5327,9487,6794,3409,9582,4000,934,6384,9650,1428,9790,2513,6952,1681,2486,378,6232,5533,1059,9461,1530,3783,3318,1166,5834,2451,5289,3990,3217,9850,7775,2036,6260,2808,1635,3855,1621,2456,4059,1889,3082,4168,7915,5052,157,188,7702,7503,8684,4548,2924,8427,5074,6480,1304,2750,8769,8373,1639,2815,8403,1201,7860,1263,6212,129,2620,9389,738,9170,377,5317,2472,6808,4816,4070,1382,8370,5366,5393,7345,5795,3764,4392,4132,1234,8490,5407,9361,4537,7315,864,1629,8793,1077,5916,8456,7472,9090,7874,1568,3177,7334,7304,1541,8186,8046,7138,7474,5685,3265,4634,1764,1959,6062,2246,9788,4043,5819,2713,6331,9139,7021,656,3602,2440,9597,6539,4301,9037,3573,82,4579,9865,7175,2934,2350,3468,9738,4223,6997,2679,3435,3887,9996,296,9488,6640,5873,3652,6251,8227,2258,152,2070,4826,5331,4249,4039,9662,1258,6784,463,9892,8329,6963,3804,9208,6429,763,1200,8042,7945,7342,4724,6150,2564,1016,8674,6611,532,7912,5136,1569,3649,6426,6549,4784,2584,285,5318,601,6800,626,4461,9130,784,3589,6475,3033,2959,4556,1307,1318,4020,1069,7758,7891,6849,4478,1230,2479,3327,2502,5939,8034,6995,4741,9178,7389,2387,698,2549,6827,125,7765,7917,6499,6845,3881,4508,2155,5375,76,7590,4023,5274,4519,4358,7110,4673,5493,9386,4999,9572,8106,9261,4504,5767,9379,9235,8897,4812,7260,7609,2880,5119,3596,8952,7349,8119,5855,1992,8804,9929,8080,8730,4853,3858,3639,9406,6817,3630,322,5320,355,6875,883,2766,6748,9175,4526,6341,5953,4195,2312,1049,8218,9027,2715,5360,2895,4157,6932,7181,4840,4058,1778,8424,8386,3269,3475,308,4825,8742,4943,8253,7338,169,811,7118,4950,8965,1083,2475,1213,9325,791,6801,8505,9354,4292,2673,4098,6523,9900,1084,2854,7880,4974,7823,6595,64,5490,2599,8928,6858,55,2976,7507,5040,6226,8882,505,9529,7408,7894,2922,3206,866,3058,9070,6850,8153,5069,9455,8770,7645,2172,7612,2208,3324,9733,8358,7847,9413,1820,210,9975,2631,6558,9897,8267,920,266,4661,5001,8961,6828,7488,6192,5198,4864,8162,8806,4817,8699,5980,117,4860,6880,5611,2285,4768,3484,732,8728,7022,8443,5028,427,7550,9874,389,2096,5754,3747,3676,3279,5969,8507,5140,6346,4100,5667,9370,6633,2443,7377,5693,6696,17,5544,8697,1760,2120,9937,1172,7102,6908,6084,8210,332,7989,1665,7826,755,31,1066,9518,2187,299,5709,2984,3794,561,8019,8347,9458,6163,6722,9717,8857,6469,7804,8214,665,8654,8898,6560,4511,7817,3049,5619,2537,6481,819,527,9818,6399,9225,6726,992,1856,7164,8514,5715,4145,52,6133,9214,6198,1919,9043,8033,6276,7442,4343,6199,2829,2424,8946,913,1356,2188,4302,938,7358,3487,4677,5067,5481,2664,1354,671,8916,8185,6915,8659,2321,6415,8355,1184,621,1313,980,9087,9708,3520,8853,5769,646,1057,6097,4488,4490,3105,1800,4728,2933,6859,710,8365,6363,4090,4836,2296,8282,1472,3335,4395,133,7368,384,2099,7486,2316,8988,5374,4024,3226,4564,4597,2741,8439,7966,6463,660,206,7233,7174,8029,5865,3871,4069,1219,2010,8668,7422,2756,1911,3712,81,4104,4314,6304,74,4378,1617,9922,1731,7598,4944,3743,344,70,5582,4856,2782,7762,596,4767,380,7950,1288,9949,5945,4475,9787,3376,8452,9508,8400,1256,9050,9720,6477,7831,3168,6070,6966,9210,3660,4235,3309,1930,6301,893,4643,6029,7234,4281,5403,2280,3976,8998,5273,3092,8958,4689,2678,3719,5298,694,3762,2602,826,6541,7981,105,9912,7510,1651,6438,9334,270,7834,411,6565,3774,737,8013,7373,4182,207,878,439,6116,1701,3011,1339,1369,192,8605,6568,5983,5973,782,5695,465,5510,3576,7678,2119,8735,8194,1548,3209,8030,5807,8968,3417,3291,4623,1158,4407,1586,3561,9294,9536,1584,348,7046,1555,9871,9770,3047,7295,9114,5647,9496,7913,3439,3135,2824,5444,1244,6042,5603,9303,1433,8076,7750,6600,897,1615,7481,3224,1526,1754,449,6148,3143,7577,3670,8156,8464,1055,5532,8531,7949,5267,46,3431,5132,1293,1708,9227,3473,4142,6779,9521,6203,2032,5306,7266,1987,376,750,37,654,4529,3950,2915,8709,4906,5552,1815,4912,1988,7764,7620,7946,7025,9984,8933,1368,370,9776,739,1746,113,7703,241,93,9167,1905,506,1171,779,5975,9247,8010,213,7192,9174,2005,8279,1636,4876,3191,1402,2040,4181,4963,6448,7335,6846,2228,1440,4096,829,7198,3791,108,3236,2396,3124,5060,5787,9537,2743,6375,1989,4640,7875,5833,9917,4604,1909,2533,9169,6759,3069,2973,4759,7973,4613,2714,45,8445,324,2567,8631,4468,2571,5562,2071,3100,556,8640,1577,3455,6488,2776,6643,2999,8011,3006,2499,5777,7766,636,5365,2698,357,8939,6250,6316,5734,9559,1273,4078,5830,1942,8428,8031,5835,2142,9305,2711,5343,5129,4692,6411,645,6315,8471,7167,2929,6273,2810,8326,4209,2872,5381,2574,1061,7716,8270,1443,2651,3742,9034,3267,3500,5432,4270,9513,4140,6322,468,3957,4148,6288,2935,4255,8313,1506,6461,3844,4814,4075,4094,6059,1343,8918,6781,655,9189,836,3144,8082,6959,6354,1373,1167,5794,815,15,2885,2907,6228,9094,4180,8781,1035,7232,3983,3123,5556,6710,3992,3697,6780,5142,3425,1361,248,7694,1460,8815,7789,5518,892,5790,5952,5670,6804,339,6536,255,8537,2676,5588,243,4091,2699,6926,1309,4985,7113,7196,1298,6033,2269,6826,6958,4356,9103,7983,8587,6193,5147,9665,4095,4818,7014,1849,2626,3310,7028,2972,7154,5719,7785,1883,9065,8892,2593,4525,5961,4213,7439,4593,8335,7641,3107,7815,1642,692,4952,6840,6811,3447,2788,2852,1910,7149,4480,7188,4627,6173,1078,1552,2871,3723,6051,5259,2007,4565,3369,4992,2541,7343,523,363,8333,6601,2995,6920,4429,6464,5175,5184,6138,1812,3153,8669,558,6220,570,7193,777,734,4163,8065,8881,8097,2487,7132,8498,4874,818,6164,4919,7850,544,6068,8752,8317,9108,6169,7371,2283,5601,1497,6898,9778,268,776,7104,8634,3601,4866,4581,2582,6490,9197,147,1808,398,2556,7500,5827,6829,212,7941,4687,6571,6587,7452,5266,1736,305,4572,7087,619,8692,4872,1080,3613,4642,592,8889,533,640,6763,7237,5666,7708,3152,5559,7326,5809,2710,7802,5576,1404,6452,1677,1585,8706,8608,2169,6773,7018,999,2806,6008,7380,4158,9914,7587,7400,582,8796,6401,5610,477,9024,7143,9880,8349,970,9590,7078,3540,7372,8661,5972,7224,845,3548,3024,9849,9848,9694,3768,4907,3091,2909,9495,1644,5608,5732,5345,7448,8178,5905,7073,9285,2877,2492,3438,7749,5802,488,2691,9899,9071,3820,1178,1931,4650,6973,6313,4977,647,4994,6987,1964,6739,2926,4881,7376,3145,9837,1148,2908,1626,4373,7857,9870,635,9459,5442,3491,1937,7336,4523,3232,3250,9564,9460,1169,2335,7148,7543,3526,1631,6876,9443,4932,9940,8164,4976,4494,5684,8500,175,2565,5713,7152,1756,320,4804,5979,4726,8560,2095,38,7094,8200,1799,7292,7010,9176,7268,5566,2198,1322,3443,4124,5104,3512,557,8571,9857,5371,7402,4645,6135,6043,2273,9703,1581,956,9380,5141,5346,1517,8896,6767,1108,8589,771,6167,8028,602,6512,18,9326,8785,7203,835,1466,4385,3612,6747,3581,5138,3840,3837,9962,8703,4312,9445,4801,1659,753,4290,6815,632,9490,1587,9149,3673,4411,8977,1840,6127,1605,3421,7057,7947,706,7435,9289,3012,3453,5954,7778,5449,1661,9808,4354,3259,5338,1474,3212,1969,6865,4082,4333,444,3307,8299,8601,456,843,5465,3503,2579,118,914,3814,8799,4877,7502,6802,1510,84,9144,1672,1543,8341,6366,3160,9092,4366,3559,2989,337,496,2942,7166,7561,1445,1882,3204,6012,5103,5887,3203,6957,9084,4619,7201,7520,4745,4803,921,2612,1522,4054,8708,7960,5201,2180,2430,8344,4482,6951,4226,8188,4101,6263,2971,4476,5578,1695,9562,3398,1128,6450,9233,5727,9431,537,8743,8984,6692,9581,1222,8940,1026,5762,5110,850,8656,7163,2805,7794,2529,3295,6738,9230,6099,5203,5714,313,3594,8594,9387,9047,575,403,1627,5999,8859,7799,7421,8172,9716,9600,9454,7935,8376,3353,1537,3171,7557,8120,4204,8274,1242,1087,9054,3741,4175,9630,6489,8137,994,7683,697,8787,7558,5270,2044,4344,425,8022,2052,8646,9802,3071,5242,1556,1936,6944,4116,9304,9771,5517,8791,8983,7892,2112,3032,3865,1750,1803,1463,3472,4847,2140,6124,5558,4829,666,9401,1628,6734};	
	listBin llb = mergeInsertion(lb);
	
    printList(llb, "llb");
	checkSorted(llb);

    return 0;
}

unsigned int	tSub(unsigned int k) {
	unsigned twoMultiple = 1;
	unsigned signMultiple = 1;

	for (int i = 0; i < k + 1; i++) {
		twoMultiple *= 2;
		signMultiple *= -1;
	}
	signMultiple / -1;
	return ((twoMultiple + signMultiple) /3);
}